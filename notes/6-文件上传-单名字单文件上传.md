# 文件上传-单名字单文件上传

## 前端代码

```html
<body>
  <form>
    <!-- 单文件版本 -->
    <!-- <input name="file" type="file"> -->
    <!-- 多文件版本 -->
    <input name="file" type="file" multiple="multiple">
    <input name="name" type="text">
    <button>提交</button>
  </form>

  <script>
    const form = document.querySelector('form')
    form.addEventListener('submit', (e) => {
      e.preventDefault()

      // 拿到文件
      const formData = new FormData(form)
      for(let value of formData) {
        console.log('value', value)
      }
      // 发送
      const xhr = new XMLHttpRequest()
      xhr.open('POST', 'http://localhost:8888/upload')
      // 不需要设置 请求头，因为 form 会自动设置请求头
      xhr.send(formData)
      xhr.onload = function () {}
    })
  </script>

</body>
```

前端 `html` 需要使用 工具 `http-server` ，启动服务展示前端页面

- 安装：`yarn add http-server -g`
- 使用：进入 `html` 文件目录，执行 `http-server -c-1`

## Node 准备

上传需要工具插件 `multer` 辅助，同时，存在 跨域问题，需要 `cors` 插件进行设置允许跨域

- 安装：

```bash
yarn add multer cors -D
```

- 使用方式：

```js
/**  文件上传--单文件上传版本
 * 
 *  1-解决跨域问题
 *  2-接受文件
 *    -> 2-1 准备一个文件夹放在服务器上，用于存储文件
 *    -> 2-2 需要插件帮助 multer ，下载 npm i multer，配置， 使用
 *    -> 2-3 使用 multer 配置一个接收器 ==> multer({ dest: '存放文件的路径' })
 *    -> 2-4 使用 multer 接受文件
 *       --> 哪一个路由需要接受文件，就配置在哪一个路由上
 *       --> 写在路由标识符的后面，路由处理函数的前面
 *       --> 接收器.single('前端上传文件的key')
 *   -> 2-5 在路由处理函数里面
 *      --> 会在 req 上面多一个信息叫 file
 *      --> 就是你上传的文件的信息
 *   注意：会把文件存储起来，随机命名，但是没有后缀
 */
```

代码：

```js
 const express = require('express')
 const router = express.Router()
 const cors = require('cors')

 // 2-2 需要插件帮助 multer ，下载 npm i multer，配置， 使用
 const multer = require('multer')
 const app = express()

 // 2-3 使用 multer 配置一个接收器
 const fileUpload = multer({ dest: './uploads/'})

 //  允许跨域
 app.use(cors())

//  单文件上传，fileUpload.single(name) 这里的 name 是你上传文件 form 里面的 name
 router.post('/upload', fileUpload.single('file'), (req, res) => {
   console.log('req.file', req.file);
   console.log('received upload');
   res.send(req.file.originalname)
 })

 
 app.use(router)

 app.listen(8888, () => {
   console.log('start at port 8888');
 })
```



核心要点：

- `multer({ dest: './uploads/'})` 配置上传的文件接收器
- `fileUpload.single('file')` 配置接收的文件名字
- `req.file` 在 `req` 里面可以拿到 `file` 对象，参数如下：
  - `fieldname` 文件名字，获取表单元素的名字
  - `originalname` 新的文件名，这里 `multer` 帮我们随机数命名了，**带后缀名**
  - `mimetype` 文件类型
  - `destination` 存储的目录
  - `filename` 文件名，新的随机数名字，**无后缀**
  - `path` 存储的具体路径
  - `size` 大小，单位是字节





参考资料：

- [expressjs/multer](https://github.com/expressjs/multer#readme)